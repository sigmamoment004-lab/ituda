<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–¢–£–î–ê 2.0 ‚Äî –¢–≤–æ—è –°–æ—Ü—Å–µ—Ç—å</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        :root { 
            --primary: #6c5ce7; --bg: #f0f2f5; --card: #ffffff; --text: #2d3436; --border: #eee;
        }
        body.dark { 
            --bg: #1a1a1a; --card: #2d2d2d; --text: #f0f0f0; --border: #444;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        
        header { background: var(--primary); color: white; padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        
        .post-card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; border: 1px solid var(--border); }
        .avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--primary); }
        
        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 10px; }
        .btn-theme { background: rgba(255,255,255,0.2); color: white; font-size: 20px; }
        
        .actions { display: flex; gap: 15px; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px; }
        .action-btn { background: none; border: none; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 5px; opacity: 0.8; }
        .action-btn:hover { opacity: 1; color: var(--primary); }
        
        .comments-section { margin-top: 15px; font-size: 14px; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 10px; }
        .comment { margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
        .comment-input { width: 100%; background: transparent; border: 1px solid var(--border); border-radius: 5px; color: var(--text); padding: 5px; margin-top: 5px; }

        #profile-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 20px; width: 300px; text-align: center; }
        
        textarea { width: 100%; height: 80px; border: 1px solid var(--border); border-radius: 10px; padding: 10px; resize: none; font-family: inherit; background: var(--card); color: var(--text); box-sizing: border-box; }
        .hidden { display: none !important; }
        .del-btn { position: absolute; top: 15px; right: 15px; cursor: pointer; color: #ff7675; background: none; border: none; font-size: 20px; }
    </style>
</head>
<body class="">

    <div id="auth-overlay">
        <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; color: #222;">
            <h2>–ò–¢–£–î–ê üöÄ</h2>
            <button class="btn btn-main" onclick="signInWithGoogle()" style="background: #4285F4;">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <header>
            <div style="font-size: 22px; font-weight: 900; cursor: pointer;" onclick="showProfile()">üì± –ü–†–û–§–ò–õ–¨</div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-theme" onclick="toggleTheme()">üåì</button>
                <button onclick="auth.signOut()" style="background:none; border:1px solid white; color:white; padding:5px 12px; border-radius:20px; cursor:pointer;">–í—ã—Ö–æ–¥</button>
            </div>
        </header>

        <div class="container">
            <div class="post-card">
                <textarea id="post-text" placeholder="–ß—Ç–æ —É —Ç–µ–±—è –Ω–æ–≤–æ–≥–æ?"></textarea>
                <button class="btn btn-main" onclick="sendPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
            <div id="feed"></div>
        </div>
    </div>

    <div id="profile-modal" class="hidden" onclick="this.classList.add('hidden')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="p-avatar" class="avatar" style="width: 80px; height: 80px; margin-bottom: 10px;">
            <h2 id="p-name">–ò–º—è –§–∞–º–∏–ª–∏—è</h2>
            <hr style="border-color: var(--border)">
            <p id="p-stats">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
            <button class="btn btn-main" onclick="document.getElementById('profile-modal').classList.add('hidden')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDm6_A5tpKNQBs9B2GgpZugFSzEw2uZuoU",
            authDomain: "ituda-a4fb2.firebaseapp.com",
            projectId: "ituda-a4fb2",
            storageBucket: "ituda-a4fb2.firebasestorage.app",
            messagingSenderId: "1080871557171",
            appId: "1:1080871557171:web:c9a514bcfac4cfe7502b46"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // –¢–µ–º–∞
        if(localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('dark', document.body.classList.contains('dark'));
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            await auth.signInWithPopup(provider);
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadPosts();
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
            }
        });

        async function sendPost() {
            const text = document.getElementById('post-text').value;
            if(!text.trim()) return;
            await db.collection("posts").add({
                text: text,
                author: auth.currentUser.displayName,
                uid: auth.currentUser.uid,
                likes: 0,
                likedBy: [],
                comments: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('post-text').value = "";
        }

        async function likePost(id, likedBy) {
            const uid = auth.currentUser.uid;
            if(likedBy.includes(uid)) return alert("–¢—ã —É–∂–µ –ª–∞–π–∫–Ω—É–ª!");
            await db.collection("posts").doc(id).update({
                likes: firebase.firestore.FieldValue.increment(1),
                likedBy: firebase.firestore.FieldValue.arrayUnion(uid)
            });
        }

        async function addComment(id) {
            const input = document.getElementById(`comm-${id}`);
            if(!input.value.trim()) return;
            await db.collection("posts").doc(id).update({
                comments: firebase.firestore.FieldValue.arrayUnion({
                    user: auth.currentUser.displayName,
                    text: input.value
                })
            });
            input.value = "";
        }

        async function deletePost(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?")) await db.collection("posts").doc(id).delete();
        }

        function showProfile() {
            const user = auth.currentUser;
            document.getElementById('p-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.displayName}`;
            document.getElementById('p-name').innerText = user.displayName;
            document.getElementById('profile-modal').classList.remove('hidden');
            
            db.collection("posts").where("uid", "==", user.uid).get().then(snap => {
                let totalLikes = 0;
                snap.forEach(doc => totalLikes += (doc.data().likes || 0));
                document.getElementById('p-stats').innerText = `–ü–æ—Å—Ç–æ–≤: ${snap.size} | –õ–∞–π–∫–æ–≤ —Å–æ–±—Ä–∞–Ω–æ: ${totalLikes}`;
            });
        }

        function loadPosts() {
            db.collection("posts").orderBy("createdAt", "desc").onSnapshot(snap => {
                const feed = document.getElementById('feed');
                feed.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    const id = doc.id;
                    const isMy = p.uid === auth.currentUser.uid;
                    const avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${p.author}`;
                    
                    let commsHtml = p.comments.map(c => `<div class="comment"><b>${c.user}:</b> ${c.text}</div>`).join('');
                    
                    feed.innerHTML += `
                        <div class="post-card">
                            ${isMy ? `<button class="del-btn" onclick="deletePost('${id}')">üóëÔ∏è</button>` : ''}
                            <div class="post-header" style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                <img src="${avatar}" class="avatar">
                                <div>
                                    <div style="font-weight:bold;">${p.author}</div>
                                    <div style="font-size:11px; opacity:0.6;">${p.createdAt?.toDate().toLocaleString() || '–Ω–µ–¥–∞–≤–Ω–æ'}</div>
                                </div>
                            </div>
                            <div style="font-size:16px;">${p.text}</div>
                            <div class="actions">
                                <button class="action-btn" onclick="likePost('${id}', ${JSON.stringify(p.likedBy)})">‚ù§Ô∏è ${p.likes || 0}</button>
                                <button class="action-btn" onclick="document.getElementById('c-box-${id}').classList.toggle('hidden')">üí¨ ${p.comments.length}</button>
                            </div>
                            <div id="c-box-${id}" class="hidden comments-section">
                                ${commsHtml}
                                <input id="comm-${id}" class="comment-input" placeholder="–ù–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç –∏ –Ω–∞–∂–º–∏ Enter" 
                                    onkeypress="if(event.key==='Enter') addComment('${id}')">
                            </div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
