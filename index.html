<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИТУДА NEXUS</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #6c5ce7; --bg: #f3f5f9; --text: #2d3436;
            --card: #ffffff; --border: rgba(0,0,0,0.06);
            --shadow: 0 8px 30px rgba(0,0,0,0.04);
        }
        body.dark {
            --bg: #0d1117; --text: #c9d1d9; --card: #161b22; --border: rgba(255,255,255,0.1);
        }
        * { box-sizing: border-box; transition: background 0.2s, color 0.2s; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }

        /* Шапка */
        header { 
            position: sticky; top: 0; z-index: 1000; background: var(--card); 
            border-bottom: 1px solid var(--border); padding: 10px 5%; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: 800; font-size: 24px; color: var(--accent); cursor: pointer; }

        /* Навигация */
        .nav { display: flex; gap: 20px; font-size: 20px; }
        .nav i { cursor: pointer; opacity: 0.5; }
        .nav i.active { opacity: 1; color: var(--accent); }

        .container { max-width: 600px; margin: 20px auto; padding-bottom: 100px; }

        /* Карточки */
        .card { 
            background: var(--card); border-radius: 20px; border: 1px solid var(--border);
            padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow);
        }

        /* Профиль */
        .profile-header { text-align: center; padding: 20px; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 30px; object-fit: cover; margin-bottom: 15px; border: 3px solid var(--accent); }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; font-size: 14px; }

        /* Сообщения (ЛС) */
        .im-container { height: 70vh; display: flex; flex-direction: column; }
        .im-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 14px; }
        .bubble.sent { align-self: flex-end; background: var(--accent); color: white; }
        .bubble.received { align-self: flex-start; background: var(--border); }

        /* Посты */
        .post-head { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .avatar-sm { width: 40px; height: 40px; border-radius: 12px; cursor: pointer; }
        .post-img { width: 100%; border-radius: 15px; margin-top: 10px; }

        /* Кнопки */
        .btn { 
            border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; 
            font-weight: 600; font-family: inherit; transition: 0.2s;
        }
        .btn-main { background: var(--accent); color: white; width: 100%; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; }
        textarea, input { 
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text); outline: none; margin-bottom: 10px;
        }

        /* Список друзей/поиска */
        .user-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .user-row-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        section { animation: fadeIn 0.3s ease; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="goHome()">ИТУДА</div>
        <div class="nav">
            <i class="fa-solid fa-house active" onclick="showSection('feed', this)"></i>
            <i class="fa-solid fa-paper-plane" onclick="showSection('dialogs', this)"></i>
            <i class="fa-solid fa-magnifying-glass" onclick="showSection('search', this)"></i>
            <i class="fa-solid fa-user" onclick="viewProfile(auth.currentUser.uid)"></i>
            <i class="fa-solid fa-moon" onclick="toggleTheme()"></i>
        </div>
    </header>

    <div class="container">
        <section id="s-feed">
            <div class="card">
                <textarea id="p-text" placeholder="Что нового?"></textarea>
                <div class="flex">
                    <button class="btn btn-outline" onclick="addPhoto()"><i class="fa-solid fa-image"></i></button>
                    <button class="btn btn-main" onclick="createPost()">Опубликовать</button>
                </div>
            </div>
            <div id="feed-items"></div>
        </section>

        <section id="s-search" class="hidden">
            <input type="text" placeholder="Поиск людей..." oninput="searchUsers(this.value)">
            <div id="search-results"></div>
        </section>

        <section id="s-profile" class="hidden">
            <div class="card profile-header">
                <img id="view-av" class="profile-avatar">
                <h2 id="view-name"></h2>
                <p id="view-status" style="opacity:0.6"></p>
                <div class="stats">
                    <div><b id="st-posts">0</b><br>Посты</div>
                    <div><b id="st-friends">0</b><br>Друзья</div>
                </div>
                <div id="profile-actions" class="flex"></div>
            </div>
            <div id="user-posts"></div>
        </section>

        <section id="s-chat" class="hidden">
            <div class="card im-container">
                <div id="chat-with" style="font-weight:700; border-bottom:1px solid var(--border); padding-bottom:10px">Чат</div>
                <div class="im-messages" id="im-box"></div>
                <div class="flex">
                    <input id="im-input" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') sendDirectMessage()">
                    <button class="btn btn-main" style="width:auto" onclick="sendDirectMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </section>

        <section id="s-dialogs" class="hidden">
            <h3>Мои диалоги</h3>
            <div id="dialogs-list"></div>
        </section>
    </div>

    <div id="modal-edit" class="modal hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; align-items:center; justify-content:center;">
        <div class="card" style="width:320px">
            <h3>Редактировать</h3>
            <input id="ed-name" placeholder="Имя">
            <input id="ed-av" placeholder="Ссылка на аватар">
            <input id="ed-status" placeholder="Статус">
            <button class="btn btn-main" onclick="saveMyProfile()">Сохранить</button>
            <button class="btn btn-outline" style="width:100%; margin-top:5px" onclick="document.getElementById('modal-edit').classList.add('hidden')">Отмена</button>
        </div>
    </div>

    <div id="auth-screen" style="position:fixed; inset:0; background:var(--bg); z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="color:var(--accent); font-size:40px">ИТУДА</h1>
        <button class="btn btn-main" onclick="auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())" style="width:250px">Войти через Google</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDm6_A5tpKNQBs9B2GgpZugFSzEw2uZuoU",
            authDomain: "ituda-a4fb2.firebaseapp.com",
            projectId: "ituda-a4fb2",
            storageBucket: "ituda-a4fb2.appspot.com",
            messagingSenderId: "1080871557171",
            appId: "1:1080871557171:web:c9a514bcfac4cfe7502b46"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const DEF_AV = "https://www.shutterstock.com/image-vector/user-profile-icon-vector-avatar-600nw-2558760599.jpg";
        let myData = {};
        let currentPhoto = "";
        let chatTarget = "";

        // Смена темы
        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('ituda_dark', document.body.classList.contains('dark'));
        }
        if(localStorage.getItem('ituda_dark') === 'true') document.body.classList.add('dark');

        // Роутинг (навигация)
        function showSection(id, el) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('s-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            if(id === 'feed') renderFeed();
            if(id === 'dialogs') renderDialogs();
        }

        function goHome() { showSection('feed', document.querySelector('.fa-house')); }

        // Юзеры и Профили
        auth.onAuthStateChanged(async user => {
            if(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                await syncUser(user);
                goHome();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        async function syncUser(u) {
            const doc = await db.collection("users").doc(u.uid).get();
            if(!doc.exists) {
                myData = { name: u.displayName, av: "", status: "Привет, я в Итуде!", friends: [] };
                await db.collection("users").doc(u.uid).set(myData);
            } else {
                myData = doc.data();
            }
        }

        async function viewProfile(uid) {
            showSection('profile', document.querySelector('.fa-user'));
            const uDoc = await db.collection("users").doc(uid).get();
            const u = uDoc.data();
            
            document.getElementById('view-av').src = u.av || DEF_AV;
            document.getElementById('view-name').innerText = u.name;
            document.getElementById('view-status').innerText = u.status;
            document.getElementById('st-friends').innerText = (u.friends || []).length;

            const acts = document.getElementById('profile-actions');
            acts.innerHTML = "";
            
            if(uid === auth.currentUser.uid) {
                acts.innerHTML = `<button class="btn btn-main" onclick="editMyProfile()">Редактировать</button>`;
            } else {
                const isFriend = myData.friends.includes(uid);
                acts.innerHTML = `
                    <button class="btn btn-main" onclick="openChat('${uid}', '${u.name}')">Сообщение</button>
                    <button class="btn btn-outline" onclick="toggleFriend('${uid}')">${isFriend ? 'Удалить друга' : 'В друзья'}</button>
                `;
            }

            renderUserPosts(uid);
        }

        function editMyProfile() {
            document.getElementById('ed-name').value = myData.name;
            document.getElementById('ed-av').value = myData.av;
            document.getElementById('ed-status').value = myData.status;
            document.getElementById('modal-edit').classList.remove('hidden');
        }

        async function saveMyProfile() {
            const up = {
                name: document.getElementById('ed-name').value,
                av: document.getElementById('ed-av').value,
                status: document.getElementById('ed-status').value
            };
            await db.collection("users").doc(auth.currentUser.uid).update(up);
            myData = {...myData, ...up};
            document.getElementById('modal-edit').classList.add('hidden');
            viewProfile(auth.currentUser.uid);
        }

        async function toggleFriend(uid) {
            const action = myData.friends.includes(uid) ? 'arrayRemove' : 'arrayUnion';
            await db.collection("users").doc(auth.currentUser.uid).update({ friends: firebase.firestore.FieldValue[action](uid) });
            await db.collection("users").doc(uid).update({ friends: firebase.firestore.FieldValue[action](auth.currentUser.uid) });
            myData.friends = action === 'arrayUnion' ? [...myData.friends, uid] : myData.friends.filter(f => f !== uid);
            viewProfile(uid);
        }

        // Посты
        function addPhoto() {
            const url = prompt("Ссылка на фото:");
            if(url) currentPhoto = url;
        }

        async function createPost() {
            const t = document.getElementById('p-text').value;
            if(!t.trim() && !currentPhoto) return;
            await db.collection("posts").add({
                uid: auth.currentUser.uid, author: myData.name, av: myData.av,
                text: t, img: currentPhoto, likes: [], date: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('p-text').value = ""; currentPhoto = "";
            renderFeed();
        }

        function renderFeed() {
            db.collection("posts").orderBy("date", "desc").limit(30).onSnapshot(snap => {
                const box = document.getElementById('feed-items');
                box.innerHTML = "";
                snap.forEach(doc => box.append(createPostEl(doc)));
            });
        }

        function renderUserPosts(uid) {
            db.collection("posts").where("uid", "==", uid).get().then(snap => {
                document.getElementById('st-posts').innerText = snap.size;
                const box = document.getElementById('user-posts');
                box.innerHTML = "<h4>Публикации</h4>";
                snap.forEach(doc => box.append(createPostEl(doc)));
            });
        }

        function createPostEl(doc) {
            const p = doc.data();
            const div = document.createElement('div');
            div.className = "card";
            div.innerHTML = `
                <div class="post-head">
                    <img src="${p.av || DEF_AV}" class="avatar-sm" onclick="viewProfile('${p.uid}')">
                    <b>${p.author}</b>
                </div>
                <div>${p.text}</div>
                ${p.img ? `<img src="${p.img}" class="post-img">` : ''}
                <div style="margin-top:10px; opacity:0.6; font-size:18px">
                    <i class="fa-heart ${p.likes.includes(auth.currentUser.uid) ? 'fa-solid' : 'fa-regular'}" 
                       onclick="likePost('${doc.id}', ${JSON.stringify(p.likes)})" style="cursor:pointer; color:${p.likes.includes(auth.currentUser.uid) ? '#ff4757' : 'inherit'}"></i> ${p.likes.length}
                </div>
            `;
            return div;
        }

        async function likePost(id, likes) {
            const act = likes.includes(auth.currentUser.uid) ? 'arrayRemove' : 'arrayUnion';
            await db.collection("posts").doc(id).update({ likes: firebase.firestore.FieldValue[act](auth.currentUser.uid) });
        }

        // Поиск
        async function searchUsers(q) {
            if(!q.trim()) return;
            const snap = await db.collection("users").get();
            const res = document.getElementById('search-results');
            res.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if(u.name.toLowerCase().includes(q.toLowerCase())) {
                    res.innerHTML += `
                        <div class="card user-row">
                            <div class="user-row-info" onclick="viewProfile('${doc.id}')">
                                <img src="${u.av || DEF_AV}" class="avatar-sm">
                                <b>${u.name}</b>
                            </div>
                            <button class="btn btn-outline" onclick="viewProfile('${doc.id}')">Профиль</button>
                        </div>
                    `;
                }
            });
        }

        // ЛИЧНЫЕ СООБЩЕНИЯ
        function openChat(uid, name) {
            chatTarget = uid;
            document.getElementById('chat-with').innerText = "Чат с " + name;
            showSection('chat');
            loadMessages();
        }

        async function sendDirectMessage() {
            const input = document.getElementById('im-input');
            if(!input.value.trim() || !chatTarget) return;
            const msg = {
                from: auth.currentUser.uid,
                to: chatTarget,
                text: input.value,
                date: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection("messages").add(msg);
            input.value = "";
        }

        function loadMessages() {
            db.collection("messages")
              .where("from", "in", [auth.currentUser.uid, chatTarget])
              .orderBy("date", "asc")
              .onSnapshot(snap => {
                  const box = document.getElementById('im-box');
                  box.innerHTML = "";
                  snap.forEach(doc => {
                      const m = doc.data();
                      if((m.from === auth.currentUser.uid && m.to === chatTarget) || (m.from === chatTarget && m.to === auth.currentUser.uid)) {
                          const div = document.createElement('div');
                          div.className = `bubble ${m.from === auth.currentUser.uid ? 'sent' : 'received'}`;
                          div.innerText = m.text;
                          box.appendChild(div);
                      }
                  });
                  box.scrollTop = box.scrollHeight;
              });
        }

        async function renderDialogs() {
            const snap = await db.collection("messages").where("to", "==", auth.currentUser.uid).get();
            const list = document.getElementById('dialogs-list');
            list.innerHTML = "";
            let uniqueUsers = [...new Set(snap.docs.map(d => d.data().from))];
            
            for(let uid of uniqueUsers) {
                const uDoc = await db.collection("users").doc(uid).get();
                const u = uDoc.data();
                list.innerHTML += `
                    <div class="card user-row" onclick="openChat('${uid}', '${u.name}')">
                        <div class="user-row-info">
                            <img src="${u.av || DEF_AV}" class="avatar-sm">
                            <b>${u.name}</b>
                        </div>
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
