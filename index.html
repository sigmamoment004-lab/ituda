<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИТУДА SUPER ULTRA 3.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7; --primary-light: #a29bfe; --bg: #f0f2f5; --text: #2d3436;
            --card: #ffffff; --border: rgba(0,0,0,0.08); --shadow: 0 10px 30px rgba(108, 92, 231, 0.1);
            --glass: rgba(255, 255, 255, 0.8);
        }
        body.dark {
            --bg: #0b0e14; --text: #e4e6eb; --card: #1c1e21; --border: rgba(255,255,255,0.1);
            --shadow: 0 10px 30px rgba(0,0,0,0.5); --glass: rgba(28, 30, 33, 0.8);
        }

        * { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--primary) transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: all 0.3s ease; overflow-x: hidden; }

        /* Кастомный скроллбар */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        header { 
            backdrop-filter: blur(15px); background: var(--glass); border-bottom: 1px solid var(--border);
            padding: 0 5%; height: 70px; display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow);
        }

        .logo { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 28px; color: var(--primary); letter-spacing: -1.5px; cursor: pointer; }
        
        .nav-menu { display: flex; gap: 25px; align-items: center; }
        .nav-item { cursor: pointer; font-size: 20px; opacity: 0.6; transition: 0.3s; position: relative; }
        .nav-item.active { opacity: 1; color: var(--primary); }
        .nav-item:hover { transform: translateY(-2px); opacity: 1; }

        .container { max-width: 700px; margin: 30px auto; padding: 0 15px; min-height: 100vh; }

        /* Создание поста */
        .glass-panel { 
            background: var(--card); border-radius: 25px; padding: 25px; border: 1px solid var(--border);
            box-shadow: var(--shadow); margin-bottom: 30px; transition: 0.3s;
        }
        .glass-panel:hover { border-color: var(--primary-light); }
        
        textarea { 
            width: 100%; border: none; background: transparent; color: var(--text); font-size: 18px; 
            resize: none; outline: none; font-family: inherit; margin-bottom: 15px; min-height: 100px;
        }

        /* Посты */
        .post { 
            background: var(--card); border-radius: 30px; padding: 25px; margin-bottom: 30px; 
            border: 1px solid var(--border); box-shadow: var(--shadow); animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .post-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; position: relative; }
        .avatar { width: 55px; height: 55px; border-radius: 20px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 2px solid var(--card); }
        .user-info b { font-size: 17px; display: flex; align-items: center; gap: 5px; }
        .verify-badge { color: #00d2ff; font-size: 14px; }
        .user-info span { font-size: 12px; opacity: 0.5; font-weight: 400; }

        .post-content { font-size: 17px; line-height: 1.6; white-space: pre-wrap; }
        .post-img { width: 100%; border-radius: 20px; margin: 15px 0; max-height: 550px; object-fit: cover; cursor: zoom-in; }
        
        .actions { display: flex; gap: 25px; border-top: 1px solid var(--border); padding-top: 20px; margin-top: 20px; }
        .btn-act { background: none; border: none; color: var(--text); cursor: pointer; font-size: 16px; opacity: 0.6; display: flex; align-items: center; gap: 8px; transition: 0.3s; padding: 8px 15px; border-radius: 12px; }
        .btn-act:hover { background: rgba(108, 92, 231, 0.1); opacity: 1; color: var(--primary); }
        .btn-act.liked { color: #ff4757; opacity: 1; }

        /* Чат */
        .chat-container { height: 70vh; display: flex; flex-direction: column; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 20px; }
        .msg { margin-bottom: 15px; display: flex; flex-direction: column; max-width: 80%; }
        .msg.me { align-self: flex-end; align-items: flex-end; }
        .msg-bubble { background: var(--card); padding: 12px 18px; border-radius: 18px; border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; }
        .me .msg-bubble { background: var(--primary); color: white; border: none; }
        .msg-info { font-size: 10px; opacity: 0.5; margin-bottom: 4px; }

        /* Поиск */
        .search-bar { width: 100%; padding: 15px 25px; border-radius: 20px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 16px; margin-bottom: 20px; outline: none; }
        .user-item { display: flex; align-items: center; gap: 15px; background: var(--card); padding: 15px; border-radius: 20px; margin-bottom: 10px; border: 1px solid var(--border); transition: 0.3s; cursor: pointer; }
        .user-item:hover { transform: scale(1.02); border-color: var(--primary); }

        /* Кнопки */
        .btn-p { background: var(--primary); color: white; border: none; padding: 14px 28px; border-radius: 18px; cursor: pointer; font-weight: 700; font-family: 'Montserrat'; transition: 0.3s; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); }
        .btn-p:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4); filter: brightness(1.1); }
        .btn-p:active { transform: scale(0.98); }

        .hidden { display: none !important; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 2000; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-box { background: var(--card); padding: 40px; border-radius: 35px; width: 400px; text-align: center; border: 1px solid var(--border); }
        
        .input-style { width: 100%; padding: 15px; border-radius: 15px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 15px; outline: none; transition: 0.3s; }
        .input-style:focus { border-color: var(--primary); }

        .status-badge { font-size: 12px; padding: 4px 10px; background: var(--primary-light); color: white; border-radius: 20px; display: inline-block; margin-top: 5px; }

    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="showSection('feed')">ИТУДА</div>
        <div class="nav-menu">
            <i class="fa-solid fa-house nav-item active" id="nav-feed" onclick="showSection('feed')"></i>
            <i class="fa-solid fa-message nav-item" id="nav-chat" onclick="showSection('chat')"></i>
            <i class="fa-solid fa-magnifying-glass nav-item" id="nav-search" onclick="showSection('search')"></i>
            <i class="fa-solid fa-user-astronaut nav-item" onclick="openProfile()"></i>
            <i class="fa-solid fa-moon nav-item" onclick="toggleTheme()"></i>
        </div>
    </header>

    <div class="container">
        <section id="sec-feed">
            <div class="glass-panel">
                <textarea id="post-text" placeholder="Что происходит в твоем мире?"></textarea>
                <div id="img-indicator" style="font-size:11px; color:var(--primary); margin-bottom:15px; font-weight:bold;"></div>
                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <button class="btn-act" onclick="addImg()"><i class="fa-solid fa-camera"></i> Фото (ссылка)</button>
                    <button class="btn-p" onclick="sendPost()">Запостить</button>
                </div>
            </div>
            <div id="feed-list"></div>
        </section>

        <section id="sec-chat" class="hidden">
            <div class="glass-panel chat-container">
                <h3 style="margin-top:0">Глобальный чат</h3>
                <div class="chat-messages" id="chat-messages"></div>
                <div style="display:flex; gap:10px">
                    <input id="chat-input" class="input-style" style="margin-bottom:0" placeholder="Напиши что-нибудь..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="btn-p" style="width:auto" onclick="sendChat()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </section>

        <section id="sec-search" class="hidden">
            <input type="text" class="search-bar" id="search-input" placeholder="Найти сигму по имени..." oninput="searchUsers()">
            <div id="user-results"></div>
        </section>
    </div>

    <div id="modal-profile" class="modal hidden">
        <div class="modal-box">
            <h2>Настройки</h2>
            <input id="u-name" class="input-style" placeholder="Твоё имя">
            <input id="u-avatar" class="input-style" placeholder="Ссылка на аватарку">
            <input id="u-status" class="input-style" placeholder="Твой статус (учусь, гуляю...)">
            <button class="btn-p" onclick="saveProfile()">Обновить всё</button>
            <p style="margin-top:20px; cursor:pointer; opacity:0.5" onclick="closeModal()">Закрыть</p>
            <button onclick="auth.signOut()" style="background:none; border:none; color:#ff4757; margin-top:20px; cursor:pointer">Выйти из аккаунта</button>
        </div>
    </div>

    <div id="auth-screen" class="modal">
        <div class="modal-box">
            <h1 style="font-family:'Montserrat'; font-weight:900; color:var(--primary); font-size:40px">ИТУДА 3.0</h1>
            <p style="margin-bottom:30px; opacity:0.7">Новая эра твоих мыслей</p>
            <button class="btn-p" onclick="login()" style="background:#4285F4; width:100%"><i class="fa-brands fa-google"></i> Войти через Google</button>
        </div>
    </div>

    <script>
        // Конфиг Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDm6_A5tpKNQBs9B2GgpZugFSzEw2uZuoU",
            authDomain: "ituda-a4fb2.firebaseapp.com",
            projectId: "ituda-a4fb2",
            storageBucket: "ituda-a4fb2.appspot.com",
            messagingSenderId: "1080871557171",
            appId: "1:1080871557171:web:c9a514bcfac4cfe7502b46"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const DEFAULT_AVATAR = "https://www.shutterstock.com/image-vector/user-profile-icon-vector-avatar-600nw-2558760599.jpg";
        let currentImg = "";
        let userData = { name: "", avatar: "", status: "", isVerified: false };

        // Инициализация темы
        if(localStorage.getItem('ituda_dark') === 'true') document.body.classList.add('dark');
        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('ituda_dark', document.body.classList.contains('dark'));
        }

        // Переключение секций
        function showSection(name) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sec-${name}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`nav-${name}`).classList.add('active');
            if(name === 'chat') { scrollChat(); loadChat(); }
            if(name === 'feed') renderFeed();
        }

        // Авторизация
        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        auth.onAuthStateChanged(async user => {
            if(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                await loadUserData(user.uid);
                showSection('feed');
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        async function loadUserData(uid) {
            const doc = await db.collection("users").doc(uid).get();
            if(doc.exists) {
                userData = doc.data();
            } else {
                userData = { name: auth.currentUser.displayName, avatar: "", status: "Новичок", isVerified: false };
                await db.collection("users").doc(uid).set(userData);
            }
        }

        function openProfile() {
            document.getElementById('u-name').value = userData.name;
            document.getElementById('u-avatar').value = userData.avatar;
            document.getElementById('u-status').value = userData.status || "";
            document.getElementById('modal-profile').classList.remove('hidden');
        }

        async function saveProfile() {
            userData.name = document.getElementById('u-name').value;
            userData.avatar = document.getElementById('u-avatar').value;
            userData.status = document.getElementById('u-status').value;
            await db.collection("users").doc(auth.currentUser.uid).update(userData);
            closeModal();
            renderFeed();
        }

        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden')); }

        function addImg() {
            const url = prompt("Прямая ссылка на фото (.jpg, .png, .gif):");
            if(url) { currentImg = url; document.getElementById('img-indicator').innerText = "✅ ФОТО ГОТОВО К ПУБЛИКАЦИИ"; }
        }

        // Посты
        async function sendPost() {
            const txt = document.getElementById('post-text').value;
            if(!txt.trim() && !currentImg) return;
            await db.collection("posts").add({
                text: txt, img: currentImg, uid: auth.currentUser.uid,
                author: userData.name, avatar: userData.avatar,
                isVerified: userData.isVerified || false,
                likes: [], comments: [], date: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('post-text').value = ""; currentImg = "";
            document.getElementById('img-indicator').innerText = "";
        }

        function renderFeed() {
            db.collection("posts").orderBy("date", "desc").limit(50).onSnapshot(snap => {
                const list = document.getElementById('feed-list');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    const id = doc.id;
                    const av = p.avatar || DEFAULT_AVATAR;
                    const liked = p.likes.includes(auth.currentUser.uid);
                    
                    list.innerHTML += `
                        <div class="post">
                            <div class="post-header">
                                <img src="${av}" class="avatar">
                                <div class="user-info">
                                    <b>${p.author} ${p.isVerified ? '<i class="fa-solid fa-circle-check verify-badge"></i>' : ''}</b>
                                    <span>${p.date?.toDate().toLocaleString() || 'только что'}</span>
                                </div>
                                ${p.uid === auth.currentUser.uid ? `<i class="fa-solid fa-ellipsis-h" style="margin-left:auto; cursor:pointer" onclick="deletePost('${id}')"></i>` : ''}
                            </div>
                            <div class="post-content">${p.text}</div>
                            ${p.img ? `<img src="${p.img}" class="post-img" onclick="window.open('${p.img}')">` : ''}
                            <div class="actions">
                                <button class="btn-act ${liked ? 'liked' : ''}" onclick="like('${id}', ${JSON.stringify(p.likes)})">
                                    <i class="fa-${liked ? 'solid' : 'regular'} fa-heart"></i> ${p.likes.length}
                                </button>
                                <button class="btn-act" onclick="toggleComm('${id}')"><i class="fa-regular fa-comment"></i> ${p.comments.length}</button>
                            </div>
                            <div id="c-box-${id}" class="hidden">
                                <div class="comments">${p.comments.map(c => `<div class="comment"><b>${c.user}:</b> ${c.text}</div>`).join('')}</div>
                                <input class="comm-input" placeholder="Ваш комментарий..." onkeypress="if(event.key==='Enter') addComm('${id}', this.value)">
                            </div>
                        </div>
                    `;
                });
            });
        }

        async function like(id, likes) {
            const uid = auth.currentUser.uid;
            const act = likes.includes(uid) ? 'arrayRemove' : 'arrayUnion';
            await db.collection("posts").doc(id).update({ likes: firebase.firestore.FieldValue[act](uid) });
        }

        async function addComm(id, text) {
            if(!text.trim()) return;
            await db.collection("posts").doc(id).update({
                comments: firebase.firestore.FieldValue.arrayUnion({ user: userData.name, text: text })
            });
        }

        async function deletePost(id) { if(confirm("Удалить этот шедевр?")) await db.collection("posts").doc(id).delete(); }
        function toggleComm(id) { document.getElementById(`c-box-${id}`).classList.toggle('hidden'); }

        // Чат
        async function sendChat() {
            const input = document.getElementById('chat-input');
            if(!input.value.trim()) return;
            await db.collection("chat").add({
                uid: auth.currentUser.uid,
                user: userData.name,
                text: input.value,
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        }

        function loadChat() {
            db.collection("chat").orderBy("date", "asc").limitToLast(40).onSnapshot(snap => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    box.innerHTML += `
                        <div class="msg ${isMe ? 'me' : ''}">
                            <div class="msg-info">${m.user}</div>
                            <div class="msg-bubble">${m.text}</div>
                        </div>
                    `;
                });
                scrollChat();
            });
        }
        function scrollChat() { const b = document.getElementById('chat-messages'); b.scrollTop = b.scrollHeight; }

        // Поиск
        async function searchUsers() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const results = document.getElementById('user-results');
            if(!q) { results.innerHTML = ""; return; }
            
            const snap = await db.collection("users").limit(10).get();
            results.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                if(u.name.toLowerCase().includes(q)) {
                    results.innerHTML += `
                        <div class="user-item">
                            <img src="${u.avatar || DEFAULT_AVATAR}" class="avatar" style="width:40px; height:40px">
                            <div>
                                <b>${u.name} ${u.isVerified ? '✅' : ''}</b><br>
                                <span class="status-badge">${u.status || 'Статус не задан'}</span>
                            </div>
                        </div>
                    `;
                }
            });
        }
    </script>
</body>
</html>
