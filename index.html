<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–¢–£–î–ê ULTRA 2.3</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --accent: #6c5ce7; --bg: #f8f9fd; --text: #2d3436;
            --card: rgba(255, 255, 255, 0.9); --border: rgba(0,0,0,0.05);
        }
        body.dark {
            --bg: #0f111a; --text: #e0e0e0; --card: rgba(30, 33, 45, 0.9); --border: rgba(255,255,255,0.05);
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; line-height: 1.5; }
        
        header { 
            backdrop-filter: blur(10px); background: var(--card); border-bottom: 1px solid var(--border);
            padding: 12px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000;
        }

        .container { max-width: 650px; margin: 20px auto; padding: 0 15px; }

        .create-post { 
            background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 30px;
        }
        textarea { 
            width: 100%; border: none; background: transparent; color: var(--text); font-size: 18px; 
            resize: none; outline: none; font-family: inherit; margin-bottom: 15px;
        }

        .post { 
            background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 25px; 
            border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }
        .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; position: relative; }
        .avatar { width: 48px; height: 48px; border-radius: 16px; object-fit: cover; background: #eee; }
        .user-info b { font-size: 16px; display: block; }
        .user-info span { font-size: 12px; opacity: 0.5; }

        .post-img { width: 100%; border-radius: 18px; margin: 15px 0; max-height: 500px; object-fit: cover; }
        
        .actions { display: flex; gap: 20px; border-top: 1px solid var(--border); padding-top: 15px; margin-top: 15px; }
        .btn-act { background: none; border: none; color: var(--text); cursor: pointer; font-size: 15px; opacity: 0.7; transition: 0.2s; }
        .btn-act:hover { opacity: 1; color: var(--accent); transform: scale(1.05); }

        .comments { background: rgba(0,0,0,0.02); border-radius: 15px; padding: 15px; margin-top: 15px; font-size: 14px; }
        .comment { margin-bottom: 10px; display: flex; justify-content: space-between; }
        .comm-input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-top: 10px; box-sizing: border-box; }

        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-box { background: var(--card); padding: 30px; border-radius: 28px; width: 340px; text-align: center; border: 1px solid var(--border); }
        .input-style { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 15px; box-sizing: border-box; }

        .btn-p { background: var(--accent); color: white; border: none; padding: 12px 25px; border-radius: 14px; cursor: pointer; font-weight: 600; width: 100%; }
        .del-post { position: absolute; right: 0; color: #ff7675; cursor: pointer; font-size: 18px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 900; font-size: 24px; color: var(--accent); letter-spacing: -1px;">–ò–¢–£–î–ê</div>
        <div style="display:flex; gap: 15px; align-items: center;">
            <i class="fa-solid fa-circle-half-stroke" style="cursor:pointer" onclick="toggleTheme()"></i>
            <i class="fa-solid fa-user-gear" style="cursor:pointer" onclick="openProfile()"></i>
            <button onclick="auth.signOut()" style="border:1px solid var(--accent); background:none; color:var(--accent); padding:6px 15px; border-radius:12px; font-size:12px; cursor:pointer">–í—ã–π—Ç–∏</button>
        </div>
    </header>

    <div id="app" class="container hidden">
        <div class="create-post">
            <textarea id="post-text" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ, —Å–∏–≥–º–∞?"></textarea>
            <div id="img-indicator" style="font-size:11px; color:var(--accent); margin-bottom:10px;"></div>
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <button class="btn-act" onclick="addImg()"><i class="fa-solid fa-image"></i> –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</button>
                <button class="btn-p" style="width: auto;" onclick="sendPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
        </div>
        <div id="feed"></div>
    </div>

    <div id="modal-profile" class="modal hidden">
        <div class="modal-box">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
            <input id="u-name" class="input-style" placeholder="–ò–º—è">
            <input id="u-avatar" class="input-style" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ –∞–≤–∞—Ç–∞—Ä–∞">
            <button class="btn-p" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <p style="cursor:pointer; font-size:12px; margin-top:15px; opacity:0.5" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</p>
        </div>
    </div>

    <div id="auth-screen" class="modal">
        <div class="modal-box">
            <h1 style="color:var(--accent)">üöÄ –ò–¢–£–î–ê</h1>
            <p>–í—Ö–æ–¥–∏ –∏ —Å–æ–∑–¥–∞–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç</p>
            <button class="btn-p" onclick="login()" style="background:#4285F4"><i class="fa-brands fa-google"></i> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDm6_A5tpKNQBs9B2GgpZugFSzEw2uZuoU",
            authDomain: "ituda-a4fb2.firebaseapp.com",
            projectId: "ituda-a4fb2",
            storageBucket: "ituda-a4fb2.appspot.com",
            messagingSenderId: "1080871557171",
            appId: "1:1080871557171:web:c9a514bcfac4cfe7502b46"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const DEFAULT_AVATAR = "https://www.shutterstock.com/image-vector/user-profile-icon-vector-avatar-600nw-2558760599.jpg";
        let currentImg = "";
        let userData = { name: "", avatar: "" };

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('ituda_dark', document.body.classList.contains('dark'));
        }
        if(localStorage.getItem('ituda_dark') === 'true') document.body.classList.add('dark');

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

        auth.onAuthStateChanged(async user => {
            if(user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                await loadUserData(user.uid);
                renderFeed();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app').classList.add('hidden');
            }
        });

        async function loadUserData(uid) {
            const doc = await db.collection("users").doc(uid).get();
            if(doc.exists) {
                userData = doc.data();
            } else {
                userData = { name: auth.currentUser.displayName, avatar: "" };
                await db.collection("users").doc(uid).set(userData);
            }
        }

        function openProfile() {
            document.getElementById('u-name').value = userData.name;
            document.getElementById('u-avatar').value = userData.avatar;
            document.getElementById('modal-profile').classList.remove('hidden');
        }

        async function saveProfile() {
            userData.name = document.getElementById('u-name').value;
            userData.avatar = document.getElementById('u-avatar').value;
            await db.collection("users").doc(auth.currentUser.uid).update(userData);
            closeModal();
            renderFeed();
        }

        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden')); }

        function addImg() {
            const url = prompt("–í—Å—Ç–∞–≤—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ:");
            if(url) { currentImg = url; document.getElementById('img-indicator').innerText = "üì∑ –§–æ—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ"; }
        }

        async function sendPost() {
            const txt = document.getElementById('post-text').value;
            if(!txt.trim() && !currentImg) return;
            await db.collection("posts").add({
                text: txt, img: currentImg, uid: auth.currentUser.uid,
                author: userData.name, avatar: userData.avatar,
                likes: [], comments: [], date: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('post-text').value = ""; currentImg = "";
            document.getElementById('img-indicator').innerText = "";
        }

        function renderFeed() {
            db.collection("posts").orderBy("date", "desc").onSnapshot(snap => {
                const feed = document.getElementById('feed');
                feed.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    const id = doc.id;
                    const isMy = p.uid === auth.currentUser.uid;
                    const av = (p.avatar && p.avatar.trim() !== "") ? p.avatar : DEFAULT_AVATAR;

                    feed.innerHTML += `
                        <div class="post">
                            <div class="post-header">
                                <img src="${av}" class="avatar">
                                <div class="user-info"><b>${p.author}</b><span>${p.date?.toDate().toLocaleString() || ''}</span></div>
                                ${isMy ? `<i class="fa-solid fa-trash-can del-post" onclick="deletePost('${id}')"></i>` : ''}
                            </div>
                            <div style="font-size:17px">${p.text}</div>
                            ${p.img ? `<img src="${p.img}" class="post-img">` : ''}
                            <div class="actions">
                                <button class="btn-act" onclick="like('${id}', ${JSON.stringify(p.likes)})">
                                    <i class="fa-${p.likes.includes(auth.currentUser.uid) ? 'solid' : 'regular'} fa-heart"></i> ${p.likes.length}
                                </button>
                                <button class="btn-act" onclick="toggleComm('${id}')"><i class="fa-regular fa-comment"></i> ${p.comments.length}</button>
                            </div>
                            <div id="c-box-${id}" class="hidden">
                                <div class="comments">${p.comments.map((c, i) => `
                                    <div class="comment">
                                        <span><b>${c.user}:</b> ${c.text}</span>
                                        ${c.uid === auth.currentUser.uid ? `<i class="fa-solid fa-xmark" style="opacity:0.3;cursor:pointer" onclick="delComm('${id}', ${i})"></i>` : ''}
                                    </div>`).join('')}</div>
                                <input class="comm-input" placeholder="–ù–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç –∏ –Ω–∞–∂–º–∏ Enter" onkeypress="if(event.key==='Enter') addComm('${id}', this.value)">
                            </div>
                        </div>
                    `;
                });
            });
        }

        async function like(id, likes) {
            const uid = auth.currentUser.uid;
            const action = likes.includes(uid) ? 'arrayRemove' : 'arrayUnion';
            await db.collection("posts").doc(id).update({ likes: firebase.firestore.FieldValue[action](uid) });
        }

        async function addComm(id, text) {
            if(!text.trim()) return;
            await db.collection("posts").doc(id).update({
                comments: firebase.firestore.FieldValue.arrayUnion({ user: userData.name, uid: auth.currentUser.uid, text: text })
            });
        }

        async function delComm(postId, index) {
            const doc = await db.collection("posts").doc(postId).get();
            const comms = doc.data().comments;
            comms.splice(index, 1);
            await db.collection("posts").doc(postId).update({ comments: comms });
        }

        async function deletePost(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?")) await db.collection("posts").doc(id).delete(); }
        function toggleComm(id) { document.getElementById(`c-box-${id}`).classList.toggle('hidden'); }
    </script>
</body>
</html>
